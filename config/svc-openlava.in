#!/bin/sh

# Start and stop openlava daemons
# Run by svc
. /lib/svc/share/smf_include.sh

getproparg() {
    val=`svcprop -p $1 $SMF_FMRI`
    [ -n "$val" ] && echo $val
}

# This is the root of openlava installation
# change it if installed somewhere else.
export OPENLAVA_TOP=@prefix@

# kill the old daemons first.
#
kill_daemons()
{
    kill `ps -A|grep lim|grep -v grep`
    kill `ps -A|grep res|grep -v grep`
    kill `ps -A|grep sbatchd|grep -v grep`
    kill `ps -A|grep mbatchd|grep -v grep`
}


# Process the requested operation.
case "$opcode" in
  'stop')
        echo "Stopping daemons..."
        kill_daemons
        exit $SMF_EXIT_OK
        ;;

  'start')
        LSF_CONF=$OPENLAVA_TOP/etc/lsf.conf

        if [ -f $LSF_CONF ]
        then
            kill_daemons

            # Get the location of the openlava daemons
            . $LSF_CONF

            # Export this env.variable to notify openlava daemons the loc. of
            # lsf.conf
            export LSF_ENVDIR
            export LSF_SERVERDIR
            echo "Starting daemons..."

            # multi user mode
            $LSF_SERVERDIR/lim
            echo "lim started"
            $LSF_SERVERDIR/res
            echo "res started"
            $LSF_SERVERDIR/sbatchd
            echo "sbatchd started"
            exit $SMF_EXIT_OK
        fi
        echo "$LSF_CONF: no such file or directory"
        exit $SMF_EXIT_ERR_FATAL
        ;;
  *)
        echo "Script for starting up and shutting down openlava"
        echo "Usage: $0 { start | stop | status | restart }"
        exit $SMF_EXIT_ERR_CONFIG
        ;;
esac

